name: Comprehensive Testing Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Rust å–®å…ƒæ¸¬è©¦å’Œæ•´åˆæ¸¬è©¦
  rust-tests:
    name: Rust Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy, rustfmt
    
    - name: Cache Cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          src-tauri/target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Check Rust formatting
      run: cd src-tauri && cargo fmt -- --check
    
    - name: Run Clippy
      run: cd src-tauri && cargo clippy --all-targets --all-features -- -D warnings
    
    - name: Run unit tests
      run: cd src-tauri && cargo test --lib --bins
    
    - name: Run integration tests
      run: cd src-tauri && cargo test --test integration_tests
    
    - name: Run performance tests
      run: cd src-tauri && cargo test --test performance_tests -- --test-threads=1
    
    - name: Generate test coverage
      run: |
        cd src-tauri
        cargo install cargo-tarpaulin
        cargo tarpaulin --out xml --output-dir ../coverage/
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/cobertura.xml
        flags: rust-tests

  # æ€§èƒ½åŸºæº–æ¸¬è©¦
  benchmark-tests:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache Cargo dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          src-tauri/target/
        key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Run benchmarks
      run: |
        cd src-tauri
        cargo bench --bench simple_performance
        cargo bench --bench cli_performance
    
    - name: Store benchmark results
      uses: benchmark-action/github-action-benchmark@v1
      with:
        tool: 'cargo'
        output-file-path: src-tauri/target/criterion/report/index.html
        github-token: ${{ secrets.GITHUB_TOKEN }}
        auto-push: true

  # Frontend æ¸¬è©¦
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run ESLint
      run: npm run lint:check
    
    - name: Run TypeScript check
      run: npm run typecheck
    
    - name: Build frontend
      run: npm run build:frontend

  # E2E æ¸¬è©¦ (Playwright)
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    
    services:
      # æ¨¡æ“¬è³‡æ–™åº«æœå‹™
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Rust (for Tauri)
      uses: dtolnay/rust-toolchain@stable
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y webkit2gtk-4.0-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev
    
    - name: Cache Tauri dependencies
      uses: actions/cache@v3
      with:
        path: src-tauri/target
        key: ${{ runner.os }}-tauri-${{ hashFiles('src-tauri/Cargo.lock') }}
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
    
    - name: Build application for testing
      run: npm run tauri build --debug
    
    - name: Start development server
      run: npm run dev:frontend &
      env:
        CI: true
    
    - name: Wait for server to be ready
      run: npx wait-on http://localhost:8081 --timeout 60000
    
    - name: Run E2E tests
      run: npm test
      env:
        CI: true
        HEADLESS: true
    
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: e2e-test-results
        path: |
          test-results/
          playwright-report/
    
    - name: Upload E2E coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/e2e-coverage.json
        flags: e2e-tests

  # å»ºç½®æ¸¬è©¦
  build-tests:
    name: Build Tests
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y webkit2gtk-4.0-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build desktop application
      run: npm run tauri build
    
    - name: Build CLI tool
      run: npm run cli:build
    
    - name: Test CLI installation
      run: npm run cli:install
    
    - name: Verify CLI functionality
      run: |
        cnp-unified --version
        cnp-unified health --format json

  # å®‰å…¨æ€§æ¸¬è©¦
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Rust security audit
      uses: actions-rs/audit@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Run npm security audit
      run: npm audit --audit-level moderate
    
    - name: Dependency vulnerability scan
      run: |
        npm install -g @cyclonedx/bom
        cyclonedx-npm --output-file sbom.json
    
    - name: Upload SBOM
      uses: actions/upload-artifact@v3
      with:
        name: software-bill-of-materials
        path: sbom.json

  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Shallow clones should be disabled for better analysis
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run code complexity analysis
      run: |
        cd src-tauri
        cargo install cargo-complexity
        cargo complexity --threshold 10
    
    - name: Check commit message format
      run: npm run commitlint
    
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # æ•´åˆæ¸¬è©¦å ±å‘Š
  test-report:
    name: Test Report
    runs-on: ubuntu-latest
    needs: [rust-tests, frontend-tests, e2e-tests, build-tests]
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
    
    - name: Generate comprehensive test report
      run: |
        echo "# ğŸ§ª Claude Night Pilot - æ¸¬è©¦å ±å‘Š" > test-report.md
        echo "" >> test-report.md
        echo "## æ¸¬è©¦ç‹€æ…‹ç¸½è¦½" >> test-report.md
        echo "" >> test-report.md
        echo "- ğŸ¦€ **Rust æ¸¬è©¦**: ${{ needs.rust-tests.result }}" >> test-report.md
        echo "- ğŸŒ **å‰ç«¯æ¸¬è©¦**: ${{ needs.frontend-tests.result }}" >> test-report.md
        echo "- ğŸ­ **E2E æ¸¬è©¦**: ${{ needs.e2e-tests.result }}" >> test-report.md
        echo "- ğŸ—ï¸ **å»ºç½®æ¸¬è©¦**: ${{ needs.build-tests.result }}" >> test-report.md
        echo "" >> test-report.md
        echo "## æ¸¬è©¦è¦†è“‹ç‡" >> test-report.md
        echo "- ç›®æ¨™å–®å…ƒæ¸¬è©¦è¦†è“‹ç‡: â‰¥85%" >> test-report.md
        echo "- ç›®æ¨™æ•´åˆæ¸¬è©¦è¦†è“‹ç‡: â‰¥75%" >> test-report.md
        echo "- ç›®æ¨™E2Eæ¸¬è©¦è¦†è“‹ç‡: â‰¥90% (é—œéµç”¨æˆ¶æµç¨‹)" >> test-report.md
        echo "" >> test-report.md
        echo "## æ€§èƒ½åŸºæº–" >> test-report.md
        echo "- å•Ÿå‹•æ™‚é–“: < 3ç§’" >> test-report.md
        echo "- CLIéŸ¿æ‡‰æ™‚é–“: < 100ms" >> test-report.md
        echo "- è¨˜æ†¶é«”ä½¿ç”¨: < 150MB" >> test-report.md
        echo "- è³‡æ–™åº«æŸ¥è©¢: < 50ms" >> test-report.md
    
    - name: Upload test report
      uses: actions/upload-artifact@v3
      with:
        name: comprehensive-test-report
        path: test-report.md

  # æ•ˆèƒ½ç›£æ§
  performance-monitoring:
    name: Performance Monitoring
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup monitoring
      run: |
        echo "Setting up performance monitoring..."
        # é€™è£¡å¯ä»¥æ•´åˆæ•ˆèƒ½ç›£æ§å·¥å…·ï¼Œå¦‚ Lighthouse CI
    
    - name: Run performance tests
      run: |
        echo "Running performance regression tests..."
        # åŸ·è¡Œæ•ˆèƒ½å›æ­¸æ¸¬è©¦
    
    - name: Alert on performance regression
      if: failure()
      run: |
        echo "Performance regression detected!"
        # å¯ä»¥æ•´åˆ Slack æˆ–å…¶ä»–é€šçŸ¥ç³»çµ±