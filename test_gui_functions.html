<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GUI åŠŸèƒ½æ¸¬è©¦</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .test-container {
        background: white;
        padding: 20px;
        margin: 10px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .test-result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      .btn:hover {
        background: #0056b3;
      }
      .json-output {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }
      .stat-card {
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
      }
      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
      }
      .stat-label {
        color: #666;
        font-size: 0.9em;
      }
      #progress {
        width: 100%;
        height: 20px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <h1>ğŸŒ™âœˆï¸ Claude Night Pilot GUI åŠŸèƒ½æ¸¬è©¦</h1>

    <div class="test-container">
      <h2>ğŸ“Š æ¸¬è©¦çµ±è¨ˆ</h2>
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="totalTests">0</div>
          <div class="stat-label">ç¸½æ¸¬è©¦æ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="passedTests">0</div>
          <div class="stat-label">é€šéæ¸¬è©¦</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="failedTests">0</div>
          <div class="stat-label">å¤±æ•—æ¸¬è©¦</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="successRate">0%</div>
          <div class="stat-label">æˆåŠŸç‡</div>
        </div>
      </div>
      <progress id="progress" value="0" max="100"></progress>
    </div>

    <div class="test-container">
      <h2>ğŸ”§ åŸºç¤åŠŸèƒ½æ¸¬è©¦</h2>
      <button class="btn" onclick="testHealthCheck()">å¥åº·æª¢æŸ¥</button>
      <button class="btn" onclick="testCooldownCheck()">å†·å»ç‹€æ…‹</button>
      <button class="btn" onclick="testCreatePrompt()">å‰µå»º Prompt</button>
      <button class="btn" onclick="testCreateSchedule()">å‰µå»ºæ’ç¨‹</button>
      <button class="btn" onclick="testTokenStats()">Token çµ±è¨ˆ</button>
      <div id="basicResults"></div>
    </div>

    <div class="test-container">
      <h2>ğŸ“… æ’ç¨‹ç®¡ç†æ¸¬è©¦</h2>
      <button class="btn" onclick="testScheduleCRUD()">æ’ç¨‹ CRUD æ“ä½œ</button>
      <button class="btn" onclick="testPendingSchedules()">å¾…åŸ·è¡Œæ’ç¨‹</button>
      <button class="btn" onclick="testScheduleUpdate()">æ›´æ–°æ’ç¨‹</button>
      <div id="scheduleResults"></div>
    </div>

    <div class="test-container">
      <h2>ğŸ“Š è³‡æ–™åº«æ•´åˆæ¸¬è©¦</h2>
      <button class="btn" onclick="testDatabaseIntegration()">
        å®Œæ•´è³‡æ–™åº«æ¸¬è©¦
      </button>
      <button class="btn" onclick="testDataPersistence()">
        è³‡æ–™æŒä¹…æ€§æ¸¬è©¦
      </button>
      <div id="databaseResults"></div>
    </div>

    <div class="test-container">
      <h2>ğŸ¨ GUI äº¤äº’æ¸¬è©¦</h2>
      <button class="btn" onclick="testGUIInteraction()">æ¸¬è©¦ GUI äº’å‹•</button>
      <button class="btn" onclick="testFormValidation()">è¡¨å–®é©—è­‰æ¸¬è©¦</button>
      <div id="guiResults"></div>
    </div>

    <div class="test-container">
      <h2>ğŸ“‹ æ¸¬è©¦çµæœè¨˜éŒ„</h2>
      <div id="testLog"></div>
    </div>

    <script>
      // æ¸¬è©¦çµ±è¨ˆ
      let testStats = {
        total: 0,
        passed: 0,
        failed: 0,
      };

      // è¨˜éŒ„æ¸¬è©¦çµæœ
      function logTest(name, passed, details = "", targetElement = "testLog") {
        testStats.total++;
        if (passed) {
          testStats.passed++;
        } else {
          testStats.failed++;
        }

        updateStats();

        const result = document.createElement("div");
        result.className = `test-result ${passed ? "success" : "error"}`;
        result.innerHTML = `
                <strong>${passed ? "âœ…" : "âŒ"} ${name}</strong>
                <div>${details}</div>
                <small>æ™‚é–“: ${new Date().toLocaleString()}</small>
            `;

        document.getElementById(targetElement).appendChild(result);

        // è‡ªå‹•æ»¾å‹•åˆ°æœ€æ–°çµæœ
        result.scrollIntoView({ behavior: "smooth" });
      }

      // æ›´æ–°çµ±è¨ˆæ•¸æ“š
      function updateStats() {
        document.getElementById("totalTests").textContent = testStats.total;
        document.getElementById("passedTests").textContent = testStats.passed;
        document.getElementById("failedTests").textContent = testStats.failed;

        const rate =
          testStats.total > 0
            ? Math.round((testStats.passed / testStats.total) * 100)
            : 0;
        document.getElementById("successRate").textContent = `${rate}%`;
        document.getElementById("progress").value = rate;
      }

      // æ¨¡æ“¬ Tauri invoke å‡½æ•¸ (åœ¨å¯¦éš›ç’°å¢ƒä¸­æœƒè¢«è¦†è“‹)
      window.__TAURI__ = window.__TAURI__ || {
        tauri: {
          invoke: function (command, args = {}) {
            return new Promise((resolve, reject) => {
              // æ¨¡æ“¬ API å›æ‡‰
              setTimeout(() => {
                switch (command) {
                  case "health_check":
                    resolve({
                      status: "healthy",
                      database: "connected",
                      timestamp: new Date().toISOString(),
                      version: "0.1.0",
                    });
                    break;
                  case "check_cooldown":
                    resolve({
                      is_cooling: false,
                      status: "ready",
                      cooldown_seconds: 0,
                      timestamp: new Date().toISOString(),
                    });
                    break;
                  case "create_prompt":
                    resolve(Math.floor(Math.random() * 1000) + 1);
                    break;
                  case "create_schedule":
                    resolve(Math.floor(Math.random() * 100) + 1);
                    break;
                  case "get_token_usage_stats":
                    resolve({
                      total_input_tokens: 12500,
                      total_output_tokens: 8300,
                      total_cost_usd: 0.45,
                      session_count: 23,
                      last_updated: new Date().toISOString(),
                    });
                    break;
                  case "get_pending_schedules":
                    resolve([
                      {
                        id: 1,
                        prompt_id: 1,
                        schedule_time: new Date(
                          Date.now() + 300000
                        ).toISOString(),
                        status: "pending",
                        cron_expr: null,
                        execution_count: 0,
                      },
                    ]);
                    break;
                  default:
                    reject(new Error(`Unknown command: ${command}`));
                }
              }, Math.random() * 500 + 100); // æ¨¡æ“¬ç¶²è·¯å»¶é²
            });
          },
        },
      };

      // åŸºç¤åŠŸèƒ½æ¸¬è©¦
      async function testHealthCheck() {
        try {
          const result = await window.__TAURI__.tauri.invoke("health_check");
          logTest(
            "å¥åº·æª¢æŸ¥",
            result.status === "healthy",
            `ç‹€æ…‹: ${result.status}, è³‡æ–™åº«: ${result.database}`,
            "basicResults"
          );
        } catch (error) {
          logTest("å¥åº·æª¢æŸ¥", false, `éŒ¯èª¤: ${error.message}`, "basicResults");
        }
      }

      async function testCooldownCheck() {
        try {
          const result = await window.__TAURI__.tauri.invoke("check_cooldown");
          logTest(
            "å†·å»ç‹€æ…‹æª¢æŸ¥",
            result.status === "ready",
            `å†·å»ä¸­: ${result.is_cooling}, ç‹€æ…‹: ${result.status}`,
            "basicResults"
          );
        } catch (error) {
          logTest(
            "å†·å»ç‹€æ…‹æª¢æŸ¥",
            false,
            `éŒ¯èª¤: ${error.message}`,
            "basicResults"
          );
        }
      }

      async function testCreatePrompt() {
        try {
          const promptId = await window.__TAURI__.tauri.invoke(
            "create_prompt",
            {
              title: "GUIæ¸¬è©¦Prompt",
              content: "é€™æ˜¯ä¸€å€‹é€šéGUIå‰µå»ºçš„æ¸¬è©¦Prompt",
              tags: "test,gui",
            }
          );
          logTest(
            "å‰µå»º Prompt",
            typeof promptId === "number" && promptId > 0,
            `Prompt ID: ${promptId}`,
            "basicResults"
          );
        } catch (error) {
          logTest(
            "å‰µå»º Prompt",
            false,
            `éŒ¯èª¤: ${error.message}`,
            "basicResults"
          );
        }
      }

      async function testCreateSchedule() {
        try {
          const scheduleTime = new Date(Date.now() + 300000).toISOString(); // 5åˆ†é˜å¾Œ
          const scheduleId = await window.__TAURI__.tauri.invoke(
            "create_schedule",
            {
              promptId: 1,
              scheduleTime: scheduleTime,
              cronExpr: null,
            }
          );
          logTest(
            "å‰µå»ºæ’ç¨‹",
            typeof scheduleId === "number" && scheduleId > 0,
            `æ’ç¨‹ ID: ${scheduleId}, åŸ·è¡Œæ™‚é–“: ${scheduleTime}`,
            "basicResults"
          );
        } catch (error) {
          logTest("å‰µå»ºæ’ç¨‹", false, `éŒ¯èª¤: ${error.message}`, "basicResults");
        }
      }

      async function testTokenStats() {
        try {
          const stats = await window.__TAURI__.tauri.invoke(
            "get_token_usage_stats"
          );
          logTest(
            "Token çµ±è¨ˆæŸ¥è©¢",
            stats && typeof stats.total_input_tokens === "number",
            `è¼¸å…¥ Token: ${stats.total_input_tokens}, è¼¸å‡º Token: ${stats.total_output_tokens}, æˆæœ¬: $${stats.total_cost_usd}`,
            "basicResults"
          );
        } catch (error) {
          logTest(
            "Token çµ±è¨ˆæŸ¥è©¢",
            false,
            `éŒ¯èª¤: ${error.message}`,
            "basicResults"
          );
        }
      }

      // æ’ç¨‹ç®¡ç†æ¸¬è©¦
      async function testScheduleCRUD() {
        try {
          // å‰µå»º
          const scheduleId = await window.__TAURI__.tauri.invoke(
            "create_schedule",
            {
              promptId: 1,
              scheduleTime: new Date(Date.now() + 600000).toISOString(),
              cronExpr: "0 9 * * *",
            }
          );

          // æ›´æ–°
          await window.__TAURI__.tauri.invoke("update_schedule", {
            id: scheduleId,
            status: "active",
            cronExpr: "0 10 * * *",
          });

          // åˆªé™¤
          const deleted = await window.__TAURI__.tauri.invoke(
            "delete_schedule",
            {
              id: scheduleId,
            }
          );

          logTest(
            "æ’ç¨‹ CRUD æ“ä½œ",
            deleted === true,
            `å‰µå»ºæ’ç¨‹ ID: ${scheduleId}, æ›´æ–°æˆåŠŸ, åˆªé™¤æˆåŠŸ`,
            "scheduleResults"
          );
        } catch (error) {
          logTest(
            "æ’ç¨‹ CRUD æ“ä½œ",
            false,
            `éŒ¯èª¤: ${error.message}`,
            "scheduleResults"
          );
        }
      }

      async function testPendingSchedules() {
        try {
          const schedules = await window.__TAURI__.tauri.invoke(
            "get_pending_schedules"
          );
          logTest(
            "å¾…åŸ·è¡Œæ’ç¨‹æŸ¥è©¢",
            Array.isArray(schedules),
            `æ‰¾åˆ° ${schedules.length} å€‹å¾…åŸ·è¡Œæ’ç¨‹`,
            "scheduleResults"
          );
        } catch (error) {
          logTest(
            "å¾…åŸ·è¡Œæ’ç¨‹æŸ¥è©¢",
            false,
            `éŒ¯èª¤: ${error.message}`,
            "scheduleResults"
          );
        }
      }

      async function testScheduleUpdate() {
        try {
          // å…ˆå‰µå»ºä¸€å€‹æ’ç¨‹
          const scheduleId = await window.__TAURI__.tauri.invoke(
            "create_schedule",
            {
              promptId: 1,
              scheduleTime: new Date(Date.now() + 300000).toISOString(),
              cronExpr: null,
            }
          );

          // æ›´æ–°æ’ç¨‹
          await window.__TAURI__.tauri.invoke("update_schedule", {
            id: scheduleId,
            status: "paused",
            scheduleTime: new Date(Date.now() + 600000).toISOString(),
          });

          logTest(
            "æ’ç¨‹æ›´æ–°",
            true,
            `æ’ç¨‹ ${scheduleId} æ›´æ–°æˆåŠŸ`,
            "scheduleResults"
          );
        } catch (error) {
          logTest(
            "æ’ç¨‹æ›´æ–°",
            false,
            `éŒ¯èª¤: ${error.message}`,
            "scheduleResults"
          );
        }
      }

      // è³‡æ–™åº«æ•´åˆæ¸¬è©¦
      async function testDatabaseIntegration() {
        try {
          let allPassed = true;
          const results = [];

          // æ¸¬è©¦å¤šå€‹ Prompt å‰µå»º
          for (let i = 1; i <= 3; i++) {
            const id = await window.__TAURI__.tauri.invoke("create_prompt", {
              title: `æ¸¬è©¦ Prompt ${i}`,
              content: `é€™æ˜¯ç¬¬ ${i} å€‹æ¸¬è©¦ Prompt`,
              tags: `test${i}`,
            });
            if (typeof id !== "number" || id <= 0) {
              allPassed = false;
            }
            results.push(`Prompt ${i}: ID ${id}`);
          }

          // æ¸¬è©¦ Token çµ±è¨ˆæ›´æ–°
          await window.__TAURI__.tauri.invoke("update_token_usage", {
            inputTokens: 100,
            outputTokens: 50,
            costUsd: 0.01,
          });

          logTest(
            "è³‡æ–™åº«æ•´åˆæ¸¬è©¦",
            allPassed,
            `æ‰¹é‡æ“ä½œçµæœ: ${results.join(", ")}, Tokençµ±è¨ˆå·²æ›´æ–°`,
            "databaseResults"
          );
        } catch (error) {
          logTest(
            "è³‡æ–™åº«æ•´åˆæ¸¬è©¦",
            false,
            `éŒ¯èª¤: ${error.message}`,
            "databaseResults"
          );
        }
      }

      async function testDataPersistence() {
        try {
          // å‰µå»ºæ•¸æ“š
          const promptId = await window.__TAURI__.tauri.invoke(
            "create_prompt",
            {
              title: "æŒä¹…æ€§æ¸¬è©¦",
              content: "æ¸¬è©¦æ•¸æ“šæŒä¹…æ€§",
              tags: "persistence",
            }
          );

          // ç«‹å³æŸ¥è©¢
          const prompt = await window.__TAURI__.tauri.invoke("get_prompt", {
            id: promptId,
          });

          logTest(
            "è³‡æ–™æŒä¹…æ€§æ¸¬è©¦",
            prompt && prompt.title === "æŒä¹…æ€§æ¸¬è©¦",
            `å‰µå»ºä¸¦æŸ¥è©¢ Prompt ${promptId} æˆåŠŸ`,
            "databaseResults"
          );
        } catch (error) {
          logTest(
            "è³‡æ–™æŒä¹…æ€§æ¸¬è©¦",
            false,
            `éŒ¯èª¤: ${error.message}`,
            "databaseResults"
          );
        }
      }

      // GUI äº¤äº’æ¸¬è©¦
      function testGUIInteraction() {
        let passed = true;
        const details = [];

        // æª¢æŸ¥åŸºæœ¬ DOM å…ƒç´ 
        const buttons = document.querySelectorAll(".btn");
        if (buttons.length === 0) {
          passed = false;
          details.push("æ‰¾ä¸åˆ°æ¸¬è©¦æŒ‰éˆ•");
        } else {
          details.push(`æ‰¾åˆ° ${buttons.length} å€‹æ¸¬è©¦æŒ‰éˆ•`);
        }

        // æª¢æŸ¥çµ±è¨ˆé¡¯ç¤º
        const statNumbers = document.querySelectorAll(".stat-number");
        if (statNumbers.length === 4) {
          details.push("çµ±è¨ˆé¢æ¿æ­£å¸¸é¡¯ç¤º");
        } else {
          passed = false;
          details.push("çµ±è¨ˆé¢æ¿ç•°å¸¸");
        }

        // æª¢æŸ¥é€²åº¦æ¢
        const progress = document.getElementById("progress");
        if (progress) {
          details.push("é€²åº¦æ¢å¯ç”¨");
        } else {
          passed = false;
          details.push("é€²åº¦æ¢ç¼ºå¤±");
        }

        logTest("GUI äº’å‹•æ¸¬è©¦", passed, details.join(", "), "guiResults");
      }

      function testFormValidation() {
        // æ¨¡æ“¬è¡¨å–®é©—è­‰æ¸¬è©¦
        const testForm = document.createElement("form");
        const testInput = document.createElement("input");
        testInput.type = "text";
        testInput.required = true;
        testForm.appendChild(testInput);

        // æ¸¬è©¦ç©ºå€¼é©—è­‰
        const isValid = testForm.checkValidity();

        logTest(
          "è¡¨å–®é©—è­‰æ¸¬è©¦",
          !isValid, // ç©ºå€¼æ‡‰è©²ç„¡æ•ˆ
          "ç©ºå€¼é©—è­‰å·¥ä½œæ­£å¸¸",
          "guiResults"
        );

        // æ¸¬è©¦æœ‰å€¼çš„æƒ…æ³
        testInput.value = "æ¸¬è©¦å€¼";
        const isValidWithValue = testForm.checkValidity();

        logTest(
          "è¡¨å–®å€¼é©—è­‰",
          isValidWithValue,
          "æœ‰å€¼é©—è­‰å·¥ä½œæ­£å¸¸",
          "guiResults"
        );
      }

      // é‹è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶
      async function runFullTestSuite() {
        console.log("ğŸš€ é–‹å§‹å®Œæ•´ GUI æ¸¬è©¦å¥—ä»¶...");

        // é‡ç½®çµ±è¨ˆ
        testStats = { total: 0, passed: 0, failed: 0 };
        updateStats();

        // æ¸…ç©ºæ¸¬è©¦è¨˜éŒ„
        document.getElementById("testLog").innerHTML = "";
        document.getElementById("basicResults").innerHTML = "";
        document.getElementById("scheduleResults").innerHTML = "";
        document.getElementById("databaseResults").innerHTML = "";
        document.getElementById("guiResults").innerHTML = "";

        // åŸºç¤åŠŸèƒ½æ¸¬è©¦
        await testHealthCheck();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testCooldownCheck();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testCreatePrompt();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testCreateSchedule();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testTokenStats();
        await new Promise((resolve) => setTimeout(resolve, 500));

        // æ’ç¨‹ç®¡ç†æ¸¬è©¦
        await testScheduleCRUD();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testPendingSchedules();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testScheduleUpdate();
        await new Promise((resolve) => setTimeout(resolve, 500));

        // è³‡æ–™åº«æ•´åˆæ¸¬è©¦
        await testDatabaseIntegration();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testDataPersistence();
        await new Promise((resolve) => setTimeout(resolve, 500));

        // GUI äº¤äº’æ¸¬è©¦
        testGUIInteraction();
        await new Promise((resolve) => setTimeout(resolve, 500));

        testFormValidation();

        console.log("âœ… GUI æ¸¬è©¦å¥—ä»¶å®Œæˆ");

        // é¡¯ç¤ºæœ€çµ‚å ±å‘Š
        const rate = Math.round((testStats.passed / testStats.total) * 100);
        const reportElement = document.createElement("div");
        reportElement.className = "test-result info";
        reportElement.innerHTML = `
                <h3>ğŸ“‹ æ¸¬è©¦å ±å‘Š</h3>
                <p><strong>ç¸½æ¸¬è©¦æ•¸:</strong> ${testStats.total}</p>
                <p><strong>é€šéæ¸¬è©¦:</strong> ${testStats.passed}</p>
                <p><strong>å¤±æ•—æ¸¬è©¦:</strong> ${testStats.failed}</p>
                <p><strong>æˆåŠŸç‡:</strong> ${rate}%</p>
                <p><strong>å®Œæˆæ™‚é–“:</strong> ${new Date().toLocaleString()}</p>
            `;
        document.getElementById("testLog").appendChild(reportElement);
      }

      // é é¢è¼‰å…¥å®Œæˆå¾Œé¡¯ç¤ºæ­¡è¿è¨Šæ¯
      document.addEventListener("DOMContentLoaded", function () {
        const welcomeMsg = document.createElement("div");
        welcomeMsg.className = "test-result info";
        welcomeMsg.innerHTML = `
                <h3>ğŸ‰ GUI æ¸¬è©¦å¹³å°å·²å°±ç·’</h3>
                <p>é»æ“Šä¸Šæ–¹æŒ‰éˆ•é€²è¡Œå€‹åˆ¥æ¸¬è©¦ï¼Œæˆ–ä½¿ç”¨ <code>runFullTestSuite()</code> åŸ·è¡Œå®Œæ•´æ¸¬è©¦ã€‚</p>
                <p>æ­¤æ¸¬è©¦å¹³å°æ¨¡æ“¬äº† Tauri ç’°å¢ƒï¼Œå¯ä»¥åœ¨ç€è¦½å™¨ä¸­ç›´æ¥æ¸¬è©¦ GUI åŠŸèƒ½ã€‚</p>
                <button class="btn" onclick="runFullTestSuite()">ğŸš€ åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶</button>
            `;
        document.getElementById("testLog").appendChild(welcomeMsg);
      });
    </script>
  </body>
</html>
