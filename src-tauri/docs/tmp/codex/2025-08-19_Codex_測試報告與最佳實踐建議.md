# Claude Night Pilot 測試報告與最佳實踐建議（2025-08-19）

## 摘要
- 範圍：比對近期 git 變更、盤點 CLI 指令、驗證 Rust/JS Lint 與測試、手動檢查資料庫串接、編譯執行與核心排程運作。
- 結論：
  - Rust 單元/整合測試皆通過（含排程整合測試）；CLI 可正常顯示 help 並執行多數子命令；DB 串接可用，`job list` 正常查詢。
  - Rust Clippy 嚴格模式失敗（大量未使用匯入與 deprecated API 使用）；需清理與完成排程 API 遷移。
  - Scheduler 新增 RealTimeExecutor/UnifiedScheduler 架構整體合理，但在 `SchedulerExecutor` 的 trait 實作存在高風險遞迴呼叫問題（需修正爲 FQS）。
  - 前端 ESLint 通過；Playwright CLI 基本場景多數通過，`run` 場景偶有失敗（環境/外部依賴影響）。

## 環境與指令
- Node 18、Rust stable（Workspace 本地依賴已就緒）。
- 主要指令：
  - `npm run lint:check`：ESLint（通過）
  - `npm run lint:rust`：Clippy（未通過，詳見下節）
  - `npm run test:rust`：Rust 單元測試（全部通過）
  - `cd src-tauri && cargo test --test scheduler_integration_tests`：排程整合測試（14/14 通過）
  - `npm run cli -- --help`、`cargo run --bin cnp-unified -- --help`：列出 CLI 功能（正常）
  - `cargo run --bin cnp-unified -- job list`：DB 串接驗證（正常，輸出 1 筆示例任務）
  - `cargo run --bin cron-test`：Cron 解析驗證（5 欄位失敗、6 欄位通過）

## Git 變更摘要
- 分支：`main` 本地 ahead 37；重要異動（摘錄）：
  - `src-tauri/Cargo.toml`：移除 sqlx，改用 `rusqlite`（含 `bundled`、`bundled-sqlcipher`）。新增 `tokio-cron-scheduler` 與排程模組。
  - 新增/改動：`src-tauri/src/scheduler/{mod.rs, real_time_executor.rs, unified_scheduler.rs}`、`src-tauri/tests/scheduler_integration_tests.rs`。
  - CLI：`src-tauri/src/bin/{cnp-optimized.rs, cnp-unified.rs}` 強化；`unified_interface.rs` 整合 GUI/CLI。
  - DB 層：`core/database/{connection.rs, manager.rs, repository.rs, migrations.rs, types.rs}` 大量調整（Rusqlite 實作、Pragma 配置、維護/快照）。
  - 監控：`monitoring/{health.rs, logging.rs, metrics.rs}` 增補。
  - 提交訊息顯示：新增 Claude 認證檢測與排程健康檢查、任務創建等。

## 測試與編譯結果
- Rust 單元測試：`npm run test:rust` → 全數通過（264 測試）。
- 排程整合測試：`cargo test --test scheduler_integration_tests` → 14/14 通過；涵蓋生命週期、任務管理、相容 API、層級任務、併發操作、監控與效能度量。
- Rust Clippy：`npm run lint:rust` → 失敗。
  - 代表性問題：
    - 未使用匯入：`services/*`, `claude_auth_detector.rs`, `claude_service.rs` 等。
    - deprecated 型別/模組使用：`SimpleJobManager`, `JobScheduler` 仍在多處被使用或 re-export。
  - 影響：CI 嚴格模式（`-D warnings`）下會中止；需清理或以 feature/過渡層隔離。
- 前端 ESLint：`npm run lint:check` → 通過。
- Playwright（CLI 基本）：部分案例通過（help/status/cooldown/prompt create），`run` 案例因外部環境/權限而失敗（可重試/隔離）。
- CLI 編譯與執行：
  - `cnp-optimized`/`cnp-unified` debug 編譯與執行正常；release 編譯在時限內未完成（需更長時間/CI 驗證）。

## CLI 功能盤點
- `cnp-optimized` 子命令：`execute`、`cooldown`、`health`、`benchmark`、`status`（help 顯示正常；`execute` 依賴 Unified Interface）。
- `cnp-unified` 子命令：`session`、`worktree`、`execute`、`run`、`cooldown`、`health`、`status`、`results`、`prompt`、`job`、`init`、`batch`。
  - 實測：`job list` 可查得任務（證實 DB 串接可用）。

## 資料庫串接驗證與評估
- 架構：單一 `rusqlite::Connection` 以 `Arc<Mutex<...>>` 管理，統一 `ConnectionManager` 初始化 PRAGMA：`foreign_keys`、`journal_mode`（WAL）、`synchronous`、`cache_size`、`temp_store`、`busy_timeout`。
- 表結構：`prompts`、`jobs`、`execution_results`、`usage_stats`、`system_metadata`（初始化於 `initialize_database`）。
- 維護：提供 `VACUUM`、`ANALYZE`、清理舊資料、備份/快照；測試均通過。
- 手動驗證：`cnp-unified job list` 輸出 1 筆任務；`health_check`/`statistics`/`backup`/`snapshot` 相關測試通過。
- 風險與建議：
  - 單連線 + Mutex 模式對 SQLite 合理，但長期高併發下 I/O 會形成瓶頸；可評估以「短生命週期連線」模式（每次操作 `Connection::open`）替換熱點操作，或引入輕量 queue 將批量寫入集中處理。
  - 啟用 `bundled` + `bundled-sqlcipher` 增加二進位大小與建置時間；建議以 feature gate 控制，預設不啟用 `sqlcipher`，於需加密時才啟用。
  - 可在 `health_check` 擴充檢查 `PRAGMA journal_mode` 是否確實為 WAL，以避免平台差異導致配置未生效。

## 核心排程驗證
- Cron 解析：`cron-test` 證實需要 6 欄位格式（秒 分 時 日 月 週）；5 欄位格式會失敗（符合 tokio-cron-scheduler 行爲）。
- `UnifiedScheduler` 整合測試完整通過，涵蓋：啟停、任務新增/移除、狀態查詢、階層關係、暫停/恢復、觸發、併發大量任務、健康檢查與效能度量。
- `RealTimeExecutor::start` 內含 Tokio runtime 存在性檢查（佳）；錯誤訊息具體、含疑難排解提示（可用）。

## 問題清單與最佳實踐修正建議
1) 高風險：`SchedulerExecutor` trait 實作的遞迴呼叫
   - 位置：`src-tauri/src/scheduler/mod.rs`
   - 問題：`impl SchedulerExecutor for RealTimeExecutor` 內部直接呼叫 `self.start()`、`self.stop()` 等，會解析為 trait 方法本身，導致遞迴呼叫/堆疊溢位風險。
   - 建議修正：改用完全限定語法（FQS）呼叫具體實作，例如：`RealTimeExecutor::start(self).await`，或改名 trait 方法避免與 inherent 方法同名。
   - 風險等級：高（目前測試路徑未觸發，但一旦透過 trait 物件使用將立即崩潰）。

2) Clippy 嚴格模式失敗（阻擋 CI）
   - 問題：未使用匯入、deprecated 類型/模組仍在使用或 re-export。
   - 建議：
     - 清理未使用匯入（`claude_service.rs`, `job_engine.rs`, `job_executor.rs`, `job_scheduler.rs`, `services/tests/*`, `claude_auth_detector.rs` 等）。
     - 遷移到 `UnifiedScheduler`：將 `SimpleJobManager`、`JobScheduler` 標記為 deprecated 的同時，移除對外 re-export，或以 feature flag 封存；測試層若仍需可加 `#[allow(deprecated)]`（限測試模組）。
     - 在 CI 中加入 `cargo clippy -- -D warnings` gate，確保新增程式碼維持零警告。

3) Cron 格式一致性
   - 問題：測試與說明文件同時出現 5/6 欄位示例；`cron-test` 已證實 6 欄位為必要。
   - 建議：統一文件與 CLI help 文案，明確強調 6 欄位格式；在接收 cron 的 API/CLI 層增加輸入驗證與回饋（目前 `validate_cron_expression` 僅檢查欄位數，可再強化）。

4) DB 健康檢查可觀測性
   - 建議在 `DatabaseHealthStatus` 增列 `journal_mode`、`page_size`、`wal_autocheckpoint` 等觀測欄位；於 `health_check` 檢查與報表輸出，方便現場診斷。

5) `bundled-sqlcipher` 的選用策略
   - 建議以 cargo features 控制（例如 `db-sqlcipher`），文件說明何時啟用；避免預設增加建置時間與體積。

6) CLI 安全旗標
   - `--dangerously-skip-permissions` 僅應於測試/內網環境；建議在程式碼層加環境變數門檻（如 `CNP_ALLOW_DANGEROUS=1`）或明確紅字警告，避免誤用。

7) Scheduler API 界面穩定化
   - 建議：將 `SchedulerExecutor` 作為對外穩定界面，具體實作以 `UnifiedScheduler` 暴露；保留 `RealTimeExecutor` 為內部構件。完成上述 FQS 修正後，補一個最小 trait 物件測試用例，防止回歸。

## 驗證步驟與輸出摘錄
- Rust：264 測試通過；排程整合測試 14/14 通過。
- CLI：
  - `cnp-optimized --help` 與 `cnp-unified --help` 正常。
  - `cnp-unified job list`：成功列出 1 筆任務（DB 串接 OK）。
  - `cron-test`：5 欄位失敗、6 欄位通過。
- Lint：ESLint 通過；Clippy 未通過（需清理）。

## 後續建議（優先序）
1) 立即修正 `SchedulerExecutor` 遞迴呼叫（FQS）並補上 trait 物件單測（高優先）。
2) 完成 deprecated 模組遷移與匯入清理，讓 `npm run lint:rust` 全綠（CI gate）。
3) 統一 Cron 格式文件與輸入驗證；更新 CLI/Docs。
4) 增強 DB 健康檢查與可觀測性；`journal_mode` 等 PRAGMA 實際值納入狀態。
5) 將 `sqlcipher` 以 feature gate 管控；於 README/Docs 明確說明。
6) 評估連線策略與繁忙寫入路徑的最佳化（非必要但建議）。

— 本報告由 Codex 生成（離線最佳實踐基準）；由於執行環境網路限制，無法直接查詢線上文獻，以上建議依據通用社群慣例與現場程式碼檢視而定。

